---
name: Build & Test
on  :
  push:
  pull_request:
    types: [opened, synchronize, reopened]
  release:
    types:
    -   prereleased
    -   released

jobs:
  verify-files:
    runs-on: ubuntu-latest
    steps:
    -   uses: actions/checkout@v3
    -   name: Verify Dockerfiles
        uses: hadolint/hadolint-action@v2.1.0
        with:
          dockerfile: Dockerfile*
          recursive: true
          verbose: true
          failure-threshold: error
    -   name: Verify scripts
        run: bash .github/scripts/verify.sh

  build:
    needs: verify-files
    name: Build & analyze with Sonar
    runs-on: ubuntu-latest
    steps:
    -   uses: actions/checkout@v3
        with:
          fetch-depth: 0         # Shallow clones should be disabled for a better relevancy of analysis
    -   name: start minikube
        id: minikube
        uses: medyagh/setup-minikube@master
    -   name: Set up JDK 17 and gradle cache
        uses: actions/setup-java@v3
        id: gradle-build
        with:
          java-version: '17'
          distribution: zulu
          cache: gradle
    -   run: ./gradlew :platform-api:build --no-daemon
    -   run: ./gradlew :pipeline:build --no-daemon
    -   name: Cache SonarCloud packages
        uses: actions/cache@v3
        id: setup-sonar-cache
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
    -   name: Build and analyze platform-api on Sonar
        id: sonar-check-platform-api
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}         # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew :platform-api:build sonarqube
    -   name: Build and analyze pipeline on Sonar
        id: sonar-check-pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}         # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew :pipeline:build sonarqube
    -   uses: actions/upload-artifact@v3
        with:
          name: platform-api
          path: platform-api/build/openapi
          retention-days: 14
    -   name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
    -   name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f python-runner/requirements.txt ]; then pip install -r python-runner/requirements.txt; fi
    -   name: Lint Python code with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    -   name: Copy filters and transforms
        run: |
          cp -r filters python-runner
          cp -r transforms python-runner
    -   name: Test with pytest
        run: |
          pytest
  push:
    if: github.ref_name == 'main' || github.ref_type == 'tag'
    name: Build and push container
    needs: build
    runs-on: ubuntu-latest
    steps:
    -   uses: actions/checkout@v3
    -   name: Set RELEASE_VERSION
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
    -   name: Set up JDK 17 and gradle cache
        uses: actions/setup-java@v3
        id: gradle-build
        with:
          java-version: '17'
          distribution: zulu
          cache: gradle
    -   run: |
          FILTERS_SRC="${GITHUB_WORKSPACE}/filters"
          TRANSFORM_SRC="${GITHUB_WORKSPACE}/transforms"
          DEST="${GITHUB_WORKSPACE}/platform-api/src/main/jib/datacater"
          mkdir -p $DEST
          rm -fr $DEST/*
          cp -R $FILTERS_SRC $DEST
          cp -R $TRANSFORM_SRC $DEST
    -   name: Push datacater/datacater to Docker Hub
        if: github.event.action == 'released'
        run: |
          ./gradlew :platform-api:build --no-daemon -x test \
                -Dquarkus.jib.platforms=linux/amd64,linux/arm64 \
                -Dquarkus.container-image.tag=${RELEASE_VERSION} \
                -Dquarkus.container-image.build=true \
                -Dquarkus.container-image.push=true \
                -Dquarkus.container-image.registry=docker.io \
                -Dquarkus.container-image.username=datacater \
                -Dquarkus.container-image.password=${{ secrets.DOCKERHUB_TOKEN }}
    -   name: Push datacater/pipeline to Docker Hub
        if: github.event.action == 'released'
        run: |
          ./gradlew :pipeline:build --no-daemon -x test \
                -Dquarkus.jib.platforms=linux/amd64,linux/arm64 \
                -Dquarkus.container-image.tag=${RELEASE_VERSION} \
                -Dquarkus.container-image.build=true \
                -Dquarkus.container-image.push=true \
                -Dquarkus.container-image.registry=docker.io \
                -Dquarkus.container-image.username=datacater \
                -Dquarkus.container-image.password=${{ secrets.DOCKERHUB_TOKEN }}
  push_python_runner:
    if: github.ref_name == 'main' || github.ref_type == 'tag'
    name: Build and push Python Runner image
    needs: build
    runs-on: ubuntu-latest
    steps:
    -   uses: actions/checkout@v3
    -   name: Set RELEASE_VERSION
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
    -   name: Copy filters and transforms
        run: |
          rm -rf python-runner/filters
          cp -r filters python-runner
          rm -rf python-runner/transforms
          cp -r transforms python-runner
    -   name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: datacater
          password: ${{ secrets.DOCKERHUB_TOKEN }}
    -   name: Build image and push it to DockerHub
        working-directory: python-runner
        if: github.event.action == 'released'
        run: |
          docker build -t datacater/python-runner:${RELEASE_VERSION} .
          docker push datacater/python-runner:${RELEASE_VERSION}
  build_and_push_ui:
    if: github.ref_name == 'main' || github.ref_type == 'tag'
    name: Build and push UI image
    needs: build
    runs-on: ubuntu-latest
    steps:
    -   uses: actions/checkout@v3
    -   name: Set RELEASE_VERSION
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
    -   name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: datacater
          password: ${{ secrets.DOCKERHUB_TOKEN }}
    -   name: Use Node.js v18
        uses: actions/setup-node@v1
        with:
          node-version: 18.x
    -   name: Install UI Dependencies
        working-directory: ui
        run: npm ci
    -   name: Build the UI
        working-directory: ui
        run: npm run build --if-present
    -   name: Build image and push it to DockerHub
        working-directory: ui
        if: github.event.action == 'released'
        run: |
          docker build -t datacater/ui:${RELEASE_VERSION} .
          docker push datacater/ui:${RELEASE_VERSION}
